<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="/css/styles.css" rel="stylesheet" />
  <link href="/css/map.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/daterangepicker.css" />
  <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.css' rel='stylesheet' />
  
  <script src="js/app.js"></script>
</head>
<body class="loading">
  
  <!-- Leaflet.js map -->
  <div id='map'></div>

  <!-- Menu -->
  <div id='selections' class="selections">
    <div class='content'>
      
      <!-- Select Data Sets -->

      <div id="toggles"></div>
      <a href="#" id="toggleConnections">Toggle Connections</a>

      <!-- Filter Data -->

      <!-- <label>Filter By:</label>
      <select id="month">
        <option>All Months</option>
        <option>1</option>
        <option>2</option>
        <option>3</option>
        <option>4</option>
        <option>5</option>
        <option>6</option>
        <option>7</option>
        <option>8</option>
        <option>9</option>
        <option>10</option>
        <option>11</option>
        <option>12</option>
      </select>
      <select id="day">
        <option>All Days</option>
      </select> -->

      <div class="demo" style="margin: 20px 0;">
        Filter by date:
        <input id="date-range" value="" style="width: 100%;">
      </div>
      
      <!-- <div>
        <button id="dateFilter">Filter</button>
        <button onclick="clearFilter()">Clear Filter</button>
      </div> -->
    </div>
  </div>

  <div id='loading'></div>

  <script>

    /****************************
           Testing Data
     ****************************/

    var json_files = ["/data/json/alex.json", "/data/json/2014-07-01-2014-07-08.json", "/data/json/2014-03-15-2014-03-18.json", "/data/json/2014-05-01-2014-05-15.json"]

    var xml_files = ["/data/xml/alex.xml", "/data/xml/josh.xml"]

    /****************************
             Settings
     ****************************/
    
    // Map settings
    var options = {
        
        // Mapbox's style key for applying map designs
        map_key: "stephalee.aec4ccea",
        
        // Pixel width of scatterplot points
        dot_width: 1.5,

        // Toggle path "web" of connections
        map_show_connections : true,  
        
        // Should the map connect-the-dots upon hovering
        // over a specific point
        show_paths_on_hover: false,

        // Define default map viewport: Top left & bottom right coordinates
        viewport: [[42.329077, -71.108871], [42.374200, -71.032072]],

        // Define our data source ('json', 'xml', 'api')
        data_source : "json",
        data_file   : json_files[0],

        // Trim Data Set?
        // Takes first X data entries. null for no trim
        data_splice : null,

        // Take Sample from Data Set?
        // Randomly selects X entries. null for no sampling
        data_sample : 10000,
    } 

    // Save the raw data to a global file.
    // Since we'll be manipulating, and filtering our
    // data set, we'll want to keep and original copy
    // as to avoid re-fetching ALL our data when we
    // reset filters.

    var raw_data = null;

    var test_data = null;

    /****************************
            Initialize
     ****************************/
    
    // On document ready
    $(function() {

      // Load location data.
      loadData(options.data_source, function(data){

        // Splice the data set for efficiency?
        if (options.data_splice){
          data = data.splice(0, options.data_splice);
        }

        // Sample the data set for efficiency?
        if (options.data_sample){
          
          // Take random sample of data
          data = _.sample(data, options.data_sample);

          // Sort by date
          data = _.sortBy(data, function(p){ return p.date });
        }

        // Check for missing keys
        data = removeInvalidData(data, ["latitude", "longitude", "date"])
        
        // Save data
        raw_data = data = formatData(data, "time");

        // Setup date ranger picker.
        DV.log(data[0].date + " " + data[data.length - 1].date)
        initDateRangePicker(data[0].date, data[data.length - 1].date);

        draw(data);
      })
    });

    function draw(data){
      // Initialize Leaflet map
      var leaflet_map = L.mapbox.map('map', options.map_key).fitBounds(options.viewport);

      // Render points on graph
      drawPoints(leaflet_map, data);        
    }

    function listDates(){
      _.each(raw_data, function(p){
        console.log(p.date);
      })

    }

    /****************************
            Interaction
     ****************************/    

    // Show/Hide sequential lines
    $("#toggleConnections").click(function(){
      options.map_show_connections = !options.map_show_connections;
      d3.selectAll("line").style("opacity", options.map_show_connections ? 1 : 0);
    });

    /******************************
             Date Range Picker
      https://github.com/longbill/jquery-date-range-picker
     ******************************/

    function initDateRangePicker(startdate, enddate){

      // Set String Format for Moment.js dates
      var format = "MMMM Do YYYY";

      // convert unix timestamps to Moment.js dates
      var start = moment.unix(startdate);
      var end = moment.unix(enddate);

      // Initialize default values
      var msg = start.format(format) + " to " + end.format(format);

      $("#date-range").val(msg);

      DV.log("\nDate range: " + msg);

      // Initialize datepicker element
      var datepicker = $('#date-range').dateRangePicker({
        format: format,
        startDate : start.format(format),
        endDate : end.format(format),
        shortcuts : {
          'prev-days': [3, 7, 30, 60],
          'prev': ['week','month','year'],
          'next-days':null,
          'next': null
        },
      });      
    };


  </script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.js"></script>
  <script src="/lib/jquery.daterangepicker.js"></script>
</body>
</html>
