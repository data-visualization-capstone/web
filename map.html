<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/css/style.css" rel="stylesheet" />
  <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.css' rel='stylesheet' />
  <title>Data Visualization Capstone</title>
</head>
<body id="map-content" class="loading">
  
  <!-- Leaflet.js map -->
  <div id='map'></div>

    <div id="filterMenu">
      <div id="fmToggle">
        <a href="javascript:void(0)">
          <h4>Hide Filters</h4>
        </a>
      </div>

      <div id="filterMenuBody">
        <div id="filterMenuBodyInner">
        <form action="#">
          <!-- Select Data Sets -->
          <div id="toggles"></div>

          <section id="dateSection">
            <h4>DATE FILTERS</h4> 

            <!-- Toggle Date Filtering -->
            <div class="checkbox_outer">
              <input checked type="checkbox" name="date" value="anyDate"> 
              <label>Any Date</label>           
            </div>

            <div class="checkbox_outer">
              <input checked type="checkbox" name="date" value="dateRange"> 
              <label>Date Range</label>           
            </div>

            <!-- Filter Data -->
            <div class="demo" style="margin: 20px 0;">
              Filter by date: <input id="date-range" value="" style="width: 100%;">
            </div>


          <div class="divider clear"></div> 

          <section id="timeSection">
            <h4>TIME FILTERS</h4>

            <div id="slider"></div>          

            <div class="divider"></div>

            <div class="inputGroup">
              <div class="checkbox_outer">
                <input type="checkbox" name="time" value="heatmap" checked>     
                <label>Heatmap</label>
              </div>
            </div>

            <div class="inputGroup" style="float:right;">
              <div class="checkbox_outer">
                <input type="checkbox" name="time" value="chronological">            
                <label>Chronological</label>
              </div>
            </div>        

            <div class="inputGroup">
              <div class="checkbox_outer">
                <input type="checkbox" name="time" value="plain">            
                <label>Plain</label>
              </div>
            </div>

          </section>
        </div>
      </form>
      </div>
  </div>

  <div id='loading'></div>

  <script src="js/app.js"></script>
  <script src="https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.js"></script>

  <script>

    /****************************
           Testing Data
     ****************************/

    var json_files = ["/data/json/alex.json", "/data/json/2014-07-01-2014-07-08.json", "/data/json/2014-03-15-2014-03-18.json", "/data/json/2014-05-01-2014-05-15.json"]

    var xml_files = ["/data/xml/alex.xml", "/data/xml/josh.xml"]

    /****************************
             Settings
     ****************************/
    
    // Map settings
    var options = {
        
        // Mapbox's style key for applying map designs
        map_key: "stephalee.aec4ccea",
        
        // Pixel width of scatterplot points
        dot_width: 3,

        // Toggle path "web" of connections
        map_show_connections : true,  
        
        // Should the map connect-the-dots upon hovering
        // over a specific point
        show_paths_on_hover: false,

        // Define default map viewport: Top left & bottom right coordinates
        viewport: [[42.329077, -71.108871], [42.374200, -71.032072]],

        // Define our data source ('json', 'xml', 'api')
        data_source : "json",
        data_file   : "data/json/alex.json",

        // Trim Data Set?
        // Takes first X data entries. null for no trim
        data_splice : null,

        // Take Sample from Data Set?
        // Randomly selects X entries. null for no sampling
        data_sample : 3000,

        // Active data filters
        filters : {

          // Oldest plotted point
          startdate: null,
          
          // Most recent plotted point
          enddate: null,

          // How should dots be colored?
          colorBy: 'time',
        }
    } 

    // Save the Raw Data.
    // Since we'll be manipulating, and filtering our
    // data set, we'll want to keep and original copy
    // as to avoid re-fetching ALL our data when we
    // reset filters.

    var raw_data = null;

    // Save the Filtered Data.
    // This is whatever data is currently being plotted.

    var filtered_data = null;

    // Global variable for map object

    var leaflet_map = null;

    /****************************
            Initialize
     ****************************/
    
    // On document ready
    $(function() {

      // Load location data.
      loadData(options.data_source, function(data){

        // Splice the data set for efficiency?
        if (options.data_splice){
          data = data.splice(0, options.data_splice);
        }

        // Sample the data set for efficiency?
        if (options.data_sample){
          
          // Take random sample of data
          data = _.sample(data, options.data_sample);

          // Sort by date
          data = _.sortBy(data, function(p){ return p.date });
        }

        // Check for missing keys
        data = removeInvalidData(data, ["latitude", "longitude", "date"])
        
        // Save data. The only time RAW and FILTERED data will be the same.
        raw_data = filtered_data = formatData(data, "time");

        DV.log(filtered_data[0]);

        // Setup date ranger picker.
        initDateRangePicker(filtered_data[0].date, filtered_data[filtered_data.length - 1].date);

        // Render the current filtered subset of data
        draw(filtered_data);
      })
    });
  
    // Initialize map and plot data
    function draw(data){
      
      // Initialize Leaflet map
      leaflet_map = L.mapbox.map('map', options.map_key).fitBounds(options.viewport);

      // Render points on graph
      drawPoints(leaflet_map, data);
    }

    // Apply updated data set
    function updateMap(data){

      // Clear map
      leaflet_map.remove();

      draw(filtered_data);

      // @TODO:
      // Like, write this function

    }

    /****************************
            Filters
     ****************************/    

    // Subset "filtered_data" by the provided start & end date.
    function filterByDate(startdate, enddate){

      // DV.log("\nFiltering by date range: " + startdate + " to " + enddate);

      filtered_data = _.filter(raw_data, function(p){

        // Passes filter if:
        a = startdate < p.date;
        b = enddate > p.date;
        return a && b;
      })

      DV.log("\n" + raw_data.length + " points filtered by time range to " + filtered_data.length + " points");

      return filtered_data;
    }

    // Initialize slider for time range
    $("#slider").noUiSlider({
      start: [20, 80],
      connect: true,
      range: {
        'min': 0,
        'max': 100
      }
    });

    /****************************
            Interaction
     ****************************/    

    // Show/Hide sequential lines
    $("#toggleConnections").click(function(){
      options.map_show_connections = !options.map_show_connections;
      d3.selectAll("line").style("opacity", options.map_show_connections ? 1 : 0);
    });

    /******************************
             Date Range Picker
      https://github.com/longbill/jquery-date-range-picker
     ******************************/

    function initDateRangePicker(startdate, enddate){

      // Set String Format for Moment.js dates
      var format = "MMMM Do YYYY";

      // convert unix timestamps to Moment.js dates
      var start = moment.unix(startdate);
      var end = moment.unix(enddate);

      // Initialize default values
      var msg = start.format(format) + " to " + end.format(format);

      $("#date-range").val(msg);

      DV.log("\nDate range: " + msg);

      // Initialize datepicker element
      var datepicker = $('#date-range').dateRangePicker({
        format: format,
        startDate : start.format(format),
        endDate : end.format(format),
        autoClose: true,
        shortcuts : {
          'prev-days': [3, 7, 30, 60],
          'prev': ['week','month','year'],
          'next-days':null,
          'next': null,
        },

      // Bind callback when date range is updated
      }).bind('datepicker-change',function(event, obj){

        DV.log("\n Date Range Updated:");
        DV.log(obj.value);

        // Filter data set
        updateMap(filterByDate(moment(obj.date1).unix(), moment(obj.date2).unix()));
      })
    };


  </script>
</body>
</html>
