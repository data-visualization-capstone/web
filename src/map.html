<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/css/semantic-ui.css" rel="stylesheet" />
  <link href="/css/nouislider.css" rel="stylesheet" />
  <link href='https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.css' rel='stylesheet' />  
  <link href="/build/style.css" rel="stylesheet" />
  <title>Data Visualization Capstone</title>
</head>

<body id="map-content">
  
  <!-- Sidebar -->
  <div id="menu"></div>

  <!-- Toggle Side Nav -->
  <div id="sideNavToggle" class="ui secondary button right out" onclick="UI.toggleSideNav('#sideNavToggle');">Hide Menu</div>

  <!-- Leaflet.js map -->
  <div id='map'></div>

  <!-- Loading Indicator -->
  <div id="loading" class="spin" style="display: none;"></div>

  <!-- Legend -->
  <div id="legend"></div>

  <!-- Data Visualization Script -->
  <script src="build/build.js"></script>

  <!-- Load in Sample Data -->
  <script src="js/data/apartments.js"></script>
  
  <!-- External -->
  <script src="https://api.tiles.mapbox.com/mapbox.js/v1.6.3/mapbox.js"></script>
  <script src="http://d3js.org/d3.hexbin.v0.min.js?5c6e4f0"></script>
  <script src='//api.tiles.mapbox.com/mapbox.js/plugins/leaflet-omnivore/v0.2.0/leaflet-omnivore.min.js'></script>

  <script>

    /************************************
         Data Visualization Settings
     ************************************/



    // Map settings
    var options = {

      // Mapbox's style key for applying map designs
      map_key: "stephalee.aec4ccea",

      // Define default map viewport: 
      // Top left & bottom right coordinates
      // For reference, Boston is:
      // 42.3601° N (lat), 71.0589° W (long), or -71
      viewport: [
        [42.329077, -71.108871],
        [42.374200, -71.032072]
      ],

      // Available layers
      layers : {},
        
    }

    /************************************
              Initialize Map
     ************************************/

    // Global variable for map object
    // Initialize Leaflet map
    var map = L.mapbox.map('map', options.map_key).fitBounds(options.viewport);

    // Add layers when the map is ready.
    map.on('ready', function(){
      update(DV._layers);
    })

    // Re-add layers when the map has changed.
    map.on('viewreset', function(){
      update(DV._layers);
    })
    
    /************************************
         Add Default Data
    ************************************/

    // Possible layers.
    options.layers = {
    
      apartments : {
        
        // Set name for layer
        // used for unique ID
        name : "Hex Map",

        // Define representation of layer
        type: "hex",

        // Data from sample-data.js
        data : sample_data.apartments,
        
        // Pixel width
        width: 15,

        // Define custom color. Used if points
        //  on't have a color parameter.
        color: "#005696",
        
        // Custom function to filter data set.
        // Use to remove duplicates or process.
        filter : function(point){
          return point.value > 2000;
        },
        // Apply function to every point
        // Useful for computing color.
        map : function(point){
          return point;
        }, 
      },

      traffic : {

        name: "Twitter Traffic",
        type: "scatterplot",
        color: DV.utils.getColor(Math.random(0, 100)),
        data : null,

        // Dynamically load data
        loadData  : DV.twitter.stream,
        parameter : 'traffic',

        width: 3,

      },

      pax : {

        name: "Twitter PAX",
        type: "scatterplot",
        color: DV.utils.getColor(Math.random(0, 100)),
        data : null,

        // Dynamically load data
        loadData  : DV.twitter.stream,
        parameter : 'pax',

        width: 3,

      }, 

      mbta : {
        name : 'MBTA',
        type : 'geojson',
        loadData : DV.loadJSON,
        parameter : '/js/data/MBTARapidTransitLines.json',
      }
  };

  // Development: plot all
  _.each(options.layers, function(layer){
    DV.layers.addLayer(layer);
  })


  // d3.json("/js/data/MBTARapidTransitLines.json", function(json) {
    
  //   var layer = {
  //     name : "MBTA",
  //     type : 'geojson',
  //     data : json,
  //   }

  //   DV.layers.addLayer(layer);
  // });

  d3.csv('/js/data/census2010.csv', function(csv) {

      // Process data
      // Parse census csv, coerce strings to numbers,
      // and reject invalid rows.
      var data = _.chain(csv)
      
        // Parve relevant data
        .map(function(row){ return parseCensusRow(row)})
        
        // Remove invalid data
        .filter(function(row){ return row; })

        // Return value
        .value();


      var layer = {
        name : 'Census',
        type : 'topojson',
        data : data
      }

      DV.layers.addLayer(layer);  

  });


    function parseCensusRow(row) {

      var parsedRow = {
        id:         +row['tractid10'],
        medianRent: +row['medianrent']
      }

      if (parsedRow.id && parsedRow.medianRent) {
        return parsedRow;
      } else {
        return;
      }
    }

    /************************************
            Wire-up UI Elements
     ************************************/

    // Load Menu Template
    $("#menu").load('templates/menu.tpl.html', function(result){
        // UI.elements.layerCheckbox("#toggle_apartment_heatmaps", options.layers.apartments);  
        // UI.elements.layerCheckbox("#toggle_mbta", options.layers.red_line);
        // UI.elements.layerCheckbox("#toggle_mbta", options.layers.orange);
        // UI.elements.heatmapScale("#squareFootage");
        // UI.elements.heatmapScale("#bedrooms");
        // UI.elements.heatmapScale("#rentPrice");        
        
        // // Initialize Defaults For Filter UI
        // UI.initializeSliders();
        // UI.initializeHashtags(); 
        // UI.toggleOption();        
    });
    
  </script>
</body>

</html>